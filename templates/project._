<!DOCTYPE html>
<html>

<head>
  <meta charset='UTF-8'/>
  <link href='/ext/codemirror.css' rel='stylesheet' />
  <link href='/ext/mapbox.css' rel='stylesheet' />
  <link href='/app/base.css' rel='stylesheet' />
  <title><%= project.name %></title>
</head>

<body id='view'>

<div id='data' class='column pane'>
  <a class='button icon close' href='#menu'></a>
  <section>
    <h2>Data library</h2>
  </section>
  <%= _(library).map(this.source).join('\n') %>
</div>

<form id='settings' class='column pane util'>
  <a class='button icon close' href='#menu'></a>
  <section>
    <h2>Settings</h2>
  </section>
  <section>
    <label class='inline'>Name</label>
    <input name='name' type='text' value='<%= project.name %>' placeholder='' size='40' />
  </section>
  <section>
    <label class='inline'>Description</label>
    <textarea name='description' type='text' cols='40' rows='8'><%= project.description %></textarea>
  </section>
  <section>
    <label class='inline'>Attribution</label>
    <input name='attribution' type='text' placeholder='<%= project.attribution %>' value='<%= project.attribution %>' size='40'></textarea>
  </section>
  <section>
    <label class='inline'>Minzoom</label>
    <input id='minzoom' name='minzoom' class='min' type='range' value='<%= project.minzoom %>' min='0' max='22' step='1' onchange='rangeHandler(this, "max", "#maxzoom");' />
    <label class='range' id='minzoom-val'><%= project.minzoom %></label>
  </section>
  <section>
    <label class='inline'>Maxzoom</label>
    <input id='maxzoom' name='maxzoom' class='max' type='range' value='<%= project.maxzoom %>' min='0' max='22' step='1' onchange='rangeHandler(this, "min", "#minzoom");' />
    <label class='range' id='maxzoom-val'><%= project.maxzoom %></label>
  </section>
  <section>
    <input type='submit' value='Save' class='wide' />
  </section>
</form>
<div id='export' class='column pane util'>
  <a class='button icon close' href='#menu'></a>
  <section>
    <h2>Export</h2>
  </section>
</div>
<div id='interaction' class='column pane util'>
  <a class='button icon close' href='#menu'></a>
</div>

<div id='menu' class='column ui'>
  <nav><!--
    --><a href='#menu-util' class='minor icon conf'></a><!--
    --><a href='#menu-layers' class='major icon plus active'>Data</a>
  </nav>
  <div id='menu-layers' class='active'>
    <%= _(sources).map(this.source).join('\n') %>
  </div>
  <div id='menu-util'>
    <h3>Project</h3>
    <a class='icon conf' href='#settings'>Settings</a>
    <a class='icon export'>Export</a>
    <a class='icon tooltip'>Interaction</a>
    <h3>TileMill</h3>
    <a class='icon grid' href='/'>Recent projects</a>
    <a class='icon book'>Data library</a>
    <a class='icon gear'>Preferences</a>
  </div>
  <a href='#data' class='button data-n icon plus'>Data</a>
  <a href='#menu' class='button data-y icon close'>Data</a>
</div>

<div id='full' class='column'>
  <div id='title' class='ui'>
    <div class='left'>
      <a class='button menu-n icon menu' href='#menu'></a>
      <a class='button menu-y icon close' href='#'></a>
      <% if (project._tmp) { %>
        <a class='button icon okay' href='#saveas'>Save as</a>
      <% } else { %>
        <a class='button icon okay save' href='#'>Save</a>
      <% } %>
    </div>
    <div class='right'>
      <a class='button full-n icon full' href='#full'></a>
      <a class='button full-y icon close' href='#'></a>
    </div>
    <h3><%= project.name || 'Untitled' %></h3>
  </div>
  <div id='map' style='background-color:<%=project.background%>;'></div>
  <div id='zoomedto' class='ui'><%= project.center[2] %></div>
</div>

<div id='docs' class='column'>
  <%= this['projectCartoRef'](cartoRef) %>
</div>

<div id='code' class='column'>
  <div class='left'>
    <a class='button docs-n icon code' href='#docs'></a>
    <a class='button docs-y icon close' href='#'></a>
  </div>
  <nav id='tabs'><!--
    <% _(project.styles).keys().forEach(function(k,i) { %>
    --><a rel='<%=k%>' href='#code-<%=k.replace(/[^\w+]/g,'_')%>' class='tab <%=!i?'active':''%>'><%=k%> <span class='icon close delete'></span></a><!--
    <% }); %>
  --></nav>
  <div class='right'>
    <a class='button icon plus' href='#addtab'></a>
  </div>
</div>

<% if (project._tmp) { %>
<form id='saveas' class='modal ui'>
  <a class='button icon close' href='#'></a>
  <input type='text' placeholder='/path/to/project.tm2' size='20' id='saveas-filepath'/>
  <input type='submit' value='Save'/>
</form>
<% } %>

<form id='addtab' class='modal ui'>
  <a class='button icon close' href='#'></a>
  <input type='text' placeholder='filename.mss' size='20' id='addtab-filename' pattern='\w+\.mss'/>
  <input type='submit' value='New tab'/>
</form>

<div id='mask'></div>

<script src='/ext/underscore-min.js'></script>
<script src='/ext/codemirror.js'></script>
<script src='/ext/codemirror.runmode.js'></script>
<script src='/ext/zepto.js'></script>
<script src='/ext/backbone.js'></script>
<script src='/ext/mapbox.js'></script>
<script src='/app/lib.js'></script>
<script src='/app/codemirror.carto.js'></script>
<script src='/app/codemirror.carto.complete.js'></script>
<script>
var rangeHandler = function(el, bound, target) {
  var limit = parseInt($(target).val(),10);
  if (bound === 'max') {
    el.value = parseInt(el.value, 10) < limit ? el.value : limit;
  } else {
    el.value = parseInt(el.value, 10) > limit ? el.value : limit;
  }
  $('#' + el.id + '-val').text(el.value);
};

var map = mapbox.map('map', mapbox.layer().tilejson({ tiles:['/project/{z}/{x}/{y}.png?id=<%=project.id%>&mtime=<%=project.mtime%>'] }));
map.centerzoom({lon:<%=project.center[0]%>,lat:<%=project.center[1]%>},<%=project.center[2]%>);
map.setZoomRange(<%=project.minzoom%>,<%=project.maxzoom%>);
map.ui.zoombox.add();
map.ui.zoomer.add();
map.ui.zoomer.appendTo($('#full').get(0));
map.addCallback('zoomed', function() { $('#zoomedto').text(map.zoom()|0); });
map.addCallback('extentset', function() { $('#zoomedto').text(map.zoom()|0); });

var Tab = function(id, value) {
  var tab = CodeMirror(document.getElementById('code'), {
    value: value,
    lineNumbers: true,
    mode: {
      name: 'carto',
      reference: window.cartoRef
    }
  });
  var completer = cartoCompletion(tab, window.cartoRef);

  /*
  @TODO
  function updateSelectors(model) {
      var ids = _.map(model.get('Layer').pluck('id'),
          function(x) { return '#' + x; });
      var classes = _(model.get('Layer').pluck('class')).chain().map(
          function(c) {
              if (c == undefined) return '';
              var cs = c.split(' ');
              if (cs[0] == '') return '';
              return _.map(cs, function(x) { return '.' + x; });
          }).flatten().compact().value();
      cartoCompleter.ids(ids);
      cartoCompleter.classes(classes);
  }
  this.model.bind('change', updateSelectors);
  updateSelectors(this.model);
  */

  tab.setOption('onKeyEvent', completer.onKeyEvent);
  tab.setOption('onHighlightComplete', _(completer.setTitles).throttle(100));
  tab.getWrapperElement().id = 'code-' + id.replace(/[^\w+]/g,'_');
  return tab;
};
var code = _(<%=JSON.stringify(project.styles)%>).reduce(function(memo, value, k) {
  memo[k] = Tab(k, value);
  return memo;
}, {});
_(code).toArray().shift().getWrapperElement().className += ' active';

var Project = Backbone.Model.extend({});
Project.prototype.url = function() {
  return '/project?id=' + this.get('id');
};

var Editor = Backbone.View.extend({});
Editor.prototype.events = {
  'click a.button.save': 'save',
  'submit #settings': 'save',
  'submit #saveas': 'saveas',
  'submit #addtab': 'addtab',
  'click #tabs a.tab span.delete': 'deltab',
  'click #tabs a.tab': 'tabbed',
  'click #docs nav a': 'tabbed',
  'click #menu nav a': 'tabbed',
  'click #menu-layers a': 'tabbed',
  'click #menu-layers a .moreless': 'moreless',
  'click #data a.section': 'data',
  'click #menu-layers a.delete': 'data',
  'keydown': 'keys'
};
Editor.prototype.keys = function(ev) {
  // Escape. Collapses windows, dialogs, modals, etc.
  if (ev.which === 27) {
    window.location.href = '#';
  }
  if ((!ev.ctrlKey && !ev.metaKey) || ev.altKey || ev.shiftKey) return;
  switch (ev.which) {
  case 83: // s
    this.save();
    break;
  case 187: // +
    map.zoomBy(1);
    break;
  case 189: // -
    map.zoomBy(-1);
    break;
  case 72: // h
    map.panBy(64, 0);
    break;
  case 74: // j
    map.panBy(0, -64);
    break;
  case 75: // k
    map.panBy(0, 64);
    break;
  case 76: // l
    map.panBy(-64, 0);
    break;
  default:
    return true;
  }
  return false;
};
Editor.prototype.tabbed = function(ev) {
  var target = ev.currentTarget.href.split('#').pop();
  var context = target.split('-').slice(0,-1).join('-');
  $('#' + context + ' .active').removeClass('active');
  //$(ev.currentTarget).siblings().removeClass('active');
  $(ev.currentTarget).addClass('active');
  $('#' + target).addClass('active');
  return false;
};
Editor.prototype.moreless = function(ev) {
  var parent = $(ev.currentTarget).parent();
  parent.toggleClass('more');
  return false;
};
Editor.prototype.data = function(ev) {
  var target = $(ev.currentTarget).parent();
  if (target.parents('#menu-layers').size()) {
    target.appendTo($('#data'));
  } else {
    // Remove all other layers as we don't support compositing for now.
    $('#menu-layers > div.source').each(function() {
      $(this).appendTo('#data');
    });
    target.prependTo($('#menu-layers'));
  }
  return false;
};
Editor.prototype.addtab = function(ev) {
  var filename = $('#addtab-filename').val();
  if (!code[filename]) {
    $("<a rel='"+filename+"' href='#code-"+filename.replace(/[^\w+]/g,'_')+"' class='tab'>"+filename+" <span class='icon close delete'></span></a>").appendTo('nav#tabs');
    code[filename] = Tab(filename, '');
  }
  window.location.hash = '#';
  return false;
};
Editor.prototype.deltab = function(ev) {
  var styles = this.model.get('styles');
  var parent = $(ev.currentTarget).parent();
  var target = parent.attr('rel');
  if (!styles[target]) return false;
  if (confirm('Remove stylesheet "' + target + '"?')) {
    $(code[target].getWrapperElement()).remove();
    parent.remove();
    delete styles[target];
    delete code[target];
    this.model.set({styles:styles});
    // Set first tab to active.
    if (parent.is('.active') && $('a.tab').size())
      this.tab({ currentTarget:$('a.tab').get(0) });
  }
  return false;
};
Editor.prototype.save = function(ev, options) {
  var attr = {};
  // Grab settings form values.
  _($('#settings').serializeArray()).reduce(function(memo, field) {
    if (field.name === 'minzoom' || field.name === 'maxzoom') {
      memo[field.name] = parseInt(field.value,10);
    } else if (field.name && field.value) {
      memo[field.name] = field.value;
    }
    return memo;
  }, attr);
  // Grab styles, sources.
  attr.styles = _(code).reduce(function(memo, cm, k) {
    memo[k] = cm.getValue();
    return memo;
  }, {});
  attr.sources = $('#menu-layers div.source').map(function() {
    return $(this).attr('id').split('source-').pop();
  });

  if (this.model.get('_prefs').saveCenter)
    attr.center = [ map.center().lon, map.center().lat, map.zoom() ];

  options = options || {
    success:_(this.refresh).bind(this),
    error: _(this.error).bind(this)
  };
  this.model.save(attr, options);

  // Back out of any panes that save the project.
  if (window.location.hash === '#settings') window.location.hash = '#menu';

  return false;
};
Editor.prototype.error = function(model, resp) {
  this.clearErrors();

  if (!resp.responseText) {
    // @TODO error modal.
    // will hit this if the server is offline and the user tries to save
    // We attach a error message to this resp object so that that the Modal can display it
    // resp.err_message = 'Could not save project "' + model.id + '"';
    return;
  }

    // Assume carto.js specific error array format response.
  _(JSON.parse(resp.responseText).message.toString().split('\n')).chain()
    .compact()
    .map(function(e) { return e.match(/^(Error: )?([\w.]+):([\d]+):([\d]+) (.*)$/) || e; })
    .each(function(e) {
      if (!e.length) {
        // non line-specific error.
        // @TODO show this globally (error modal) somehow.
      } else {
        var id = e[2];
        var ln = parseInt(e[3]) - 1;
        code[id]._cartoErrors = code[id]._cartoErrors || [];
        code[id]._cartoErrors.push(ln);
        code[id].setMarker(ln, "<a id='error-"+ln+"' href='#error-"+ln+"'>%N%</a><span class='message'><a href='#' class='icon'>âœ•</a>"+e[5]+"</span>", 'error');
      }
    });
};
Editor.prototype.clearErrors = function() {
  _(code).each(function(cm) {
    _(cm._cartoErrors||[]).each(cm.clearMarker);
    delete cm._cartoErrors;
  });
};
Editor.prototype.saveas = function(ev) {
  var id = $('#saveas-filepath').val();
  this.model.set({id:id});
  this.save(null, {
    success: function() { window.location = '/project?id=' + id; },
    error: _(this.error).bind(this)
  });
  return false;
};
Editor.prototype.refresh = function(ev) {
  this.clearErrors();
  // Refresh map layer.
  var layer = map.getLayerAt(0);
  map.removeLayer(layer);
  layer.destroy();
  map.addLayer(mapbox.layer().tilejson({ tiles:['/project/{z}/{x}/{y}.png?id=<%=project.id%>&mtime=' + this.model.get('mtime') ] }));

  // Set canvas background color.
  if (this.model.get('background'))
    $('#map').css({'background-color':this.model.get('background')});

  // Refresh map title.
  $('title').text(this.model.get('name'));
  $('#title h3').text(this.model.get('name'));
  // Refresh map zoom range.
  map.setZoomRange(this.model.get('minzoom'),this.model.get('maxzoom'));
  return false;
};

new Editor({
  el: document.body,
  model: new Project(<%= JSON.stringify(project) %>)
});

// Syntax highlighting for carto ref.
$('pre.carto-snippet').each(function(i, elem) {
  var text = $(elem).text();
  $(elem).empty();
  CodeMirror.runMode(text, {name:'carto',reference:window.cartoRef}, $(elem).get(0));
});
</script>
</body>

</html>
